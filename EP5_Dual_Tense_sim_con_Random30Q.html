<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>EP5 ‚Ä¢ DUAL TENSE WARFARE ‚Ä¢ Cyber Blue √ó Red Alert</title>
<style>
  :root{
    --bg0:#02050b;
    --bg1:#060b14;
    --bg2:#0a1222;
    --cyan:#00e5ff;
    --cyan2:#4df3ff;
    --ice:#dffcff;
    --steel:#cfd7e6;
    --warn:#ff2b2b;
    --gold:#ffb86a;
    --ok:#4dff9a;
    --glass: rgba(255,255,255,.06);
    --glass2: rgba(0,229,255,.10);
    --line: rgba(0,229,255,.22);
    --shadow: 0 30px 90px rgba(0,0,0,.55);
  
    --alert:#ff003c;
    --alert2:#ff5a7a;
}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:var(--ice);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
    background:
      radial-gradient(1200px 600px at 50% -10%, rgba(0,229,255,.24), transparent 60%),
      radial-gradient(800px 500px at 85% 20%, rgba(77,243,255,.12), transparent 60%),
      radial-gradient(900px 650px at 10% 30%, rgba(255,0,60,.18), transparent 65%),
      linear-gradient(180deg, var(--bg0), var(--bg1) 45%, var(--bg2));
    overflow:hidden;
  }

  /* ====== Cinematic overlays ====== */
  .scanlines{
    pointer-events:none;
    position:fixed; inset:0;
    background: repeating-linear-gradient(
      to bottom,
      rgba(255,255,255,.035) 0px,
      rgba(255,255,255,.035) 1px,
      rgba(0,0,0,0) 3px,
      rgba(0,0,0,0) 6px
    );
    mix-blend-mode: overlay;
    opacity:.28;
  }
  .noise{
    pointer-events:none;
    position:fixed; inset:-40px;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='240' height='240' filter='url(%23n)' opacity='.32'/%3E%3C/svg%3E");
    opacity:.08;
    animation: drift 7s linear infinite;
  }
  @keyframes drift{
    0%{transform:translate3d(0,0,0)}
    50%{transform:translate3d(-14px,9px,0)}
    100%{transform:translate3d(0,0,0)}
  }

  /* ====== Fullscreen stage ====== */
  .stage{
    position:relative;
    height:100%;
    display:flex;
    flex-direction:column;
  }
  canvas#fx{
    position:fixed; inset:0;
    width:100%; height:100%;
    pointer-events:none;
  }

  /* ====== Top cinematic bar ====== */
  .topbar{
    position:relative;
    padding:18px 18px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .brand{
    display:flex;
    align-items:center;
    gap:12px;
    min-width:0;
  }
  .badge{
    width:44px;height:44px;border-radius:14px;
    background:
      radial-gradient(circle at 30% 25%, rgba(255,255,255,.35), transparent 55%),
      linear-gradient(135deg, rgba(0,229,255,.30), rgba(255,59,122,.18)),
      rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.14);
    box-shadow: 0 16px 40px rgba(0,0,0,.4);
    position:relative;
    overflow:hidden;
  }
  .badge::after{
    content:"";
    position:absolute; inset:-60px;
    background: radial-gradient(circle, rgba(77,243,255,.45), transparent 60%);
    transform: translate(-25px,-20px);
    filter: blur(10px);
    opacity:.65;
    animation: pulse 2.8s ease-in-out infinite;
  }
  @keyframes pulse{
    0%,100%{opacity:.35; transform:translate(-30px,-24px) scale(.95)}
    50%{opacity:.75; transform:translate(-10px,-8px) scale(1.08)}
  }
  .brandText{
    min-width:0;
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .brandText .kicker{
    font-weight:900;
    letter-spacing:.12em;
    font-size:12px;
    opacity:.78;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .brandText .ep{
    font-weight:1000;
    font-size:16px;
    letter-spacing:.02em;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .hud{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .chip{
    display:flex;
    align-items:center;
    gap:8px;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.32);
    box-shadow: 0 14px 40px rgba(0,0,0,.25);
    font-weight:900;
    letter-spacing:.01em;
    backdrop-filter: blur(10px);
  }
  .chip b{color:var(--cyan2)}
  .chip .dot{
    width:8px;height:8px;border-radius:99px;
    background: var(--cyan);
    box-shadow:0 0 14px rgba(0,229,255,.7);
  }

  /* ====== Main panel ====== */
  .main{
    flex:1;
    display:grid;
    place-items:center;
    padding:16px 18px 22px;
  }
  .panel{
    width:min(1120px, 100%);
    border-radius:28px;
    border:1px solid rgba(255,255,255,.14);
    background:
      radial-gradient(800px 420px at 50% 0%, rgba(0,229,255,.12), transparent 58%),
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.26));
    box-shadow: var(--shadow);
    overflow:hidden;
    position:relative;
  }
  .panel::before{
    content:"";
    position:absolute; inset:-2px;
    background:
      linear-gradient(90deg, transparent, rgba(77,243,255,.14), transparent),
      radial-gradient(800px 400px at 85% 20%, rgba(255,0,60,.18), transparent 60%);
    opacity:.9;
    pointer-events:none;
    animation: shimmer 6s linear infinite;
  }
  @keyframes shimmer{
    0%{transform:translateX(-35%)}
    100%{transform:translateX(35%)}
  }
  .panelInner{
    position:relative;
    padding:22px 22px 20px;
    display:grid;
    gap:16px;
  }

  /* ====== Cinematic title ====== */
  .hero{
    padding:18px 18px 12px;
    border-radius:24px;
    background:
      radial-gradient(600px 220px at 50% 0%, rgba(255,255,255,.10), transparent 55%),
      linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.08));
    border:1px solid rgba(255,255,255,.10);
    position:relative;
    overflow:hidden;
  }
  .hero .flare{
    position:absolute;
    width:420px;height:420px;
    background: radial-gradient(circle, rgba(0,229,255,.34), transparent 60%), radial-gradient(circle at 70% 60%, rgba(255,0,60,.22), transparent 65%);
    filter: blur(2px);
    top:-240px; left:-220px;
    opacity:.9;
    transform: rotate(18deg);
    animation: sweep 4.8s ease-in-out infinite;
  }
  @keyframes sweep{
    0%{transform:translate(-30px,10px) rotate(12deg); opacity:.35}
    45%{transform:translate(420px,210px) rotate(12deg); opacity:.95}
    100%{transform:translate(760px,260px) rotate(12deg); opacity:.25}
  }
  .heroTitle{
    position:relative;
    text-align:center;
    line-height:1;
    margin:2px 0 4px;
  }
  .heroTitle .metal{
    font-weight:1100;
    letter-spacing:.14em;
    font-size: clamp(44px, 6vw, 96px);
    text-transform:uppercase;
    background:
      linear-gradient(180deg, #f9fbff 0%, #bfc7d6 18%, #ffffff 33%, #9aa3b8 55%, #f6fbff 80%, #98a2b9 100%);
    -webkit-background-clip:text;
    background-clip:text;
    color:transparent;
    text-shadow:
      0 2px 0 rgba(0,0,0,.45),
      0 14px 40px rgba(0,0,0,.55),
      0 0 26px rgba(0,229,255,.18);
    position:relative;
  }
  .heroTitle .metal::after{
    content:"";
    position:absolute; inset:-18px -30px;
    background: linear-gradient(90deg, transparent, rgba(0,229,255,.20), transparent);
    transform: skewX(-18deg);
    mix-blend-mode: screen;
    opacity:.7;
    filter: blur(0.2px);
    animation: titleScan 3.9s linear infinite;
  }
  @keyframes titleScan{
    0%{transform:translateX(-65%) skewX(-18deg); opacity:.05}
    25%{opacity:.55}
    55%{opacity:.75}
    100%{transform:translateX(65%) skewX(-18deg); opacity:.05}
  }
  .tagline{
    text-align:center;
    font-weight:900;
    letter-spacing:.08em;
    font-size: clamp(12px, 1.6vw, 18px);
    opacity:.85;
  }
  .tagline b{
    color:var(--cyan2);
    text-shadow:0 0 14px rgba(0,229,255,.5);
  }

  /* ====== Screens ====== */
  .screen{display:none}
  .screen.active{display:block}

  /* ====== Start screen content ====== */
  .startGrid{
    display:grid;
    grid-template-columns: 1fr;
    gap:14px;
    padding:12px 6px 6px;
  }
  @media (min-width: 980px){
    .startGrid{grid-template-columns: 1.1fr .9fr; align-items:stretch}
  }
  .box{
    border-radius:22px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.26);
    padding:16px 16px;
  }
  .box h3{
    margin:0 0 8px;
    font-size:16px;
    letter-spacing:.06em;
    text-transform:uppercase;
  }
  .how{
    display:grid;
    gap:10px;
    font-weight:800;
    opacity:.92;
  }
  .pill{
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding:12px 12px;
    border-radius:18px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(0,229,255,.14);
  }
  .pill i{
    width:28px;height:28px;border-radius:12px;
    display:grid;place-items:center;
    background: rgba(0,229,255,.12);
    border:1px solid rgba(0,229,255,.25);
    box-shadow:0 0 18px rgba(0,229,255,.18);
    flex:0 0 auto;
  }
  .fieldRow{
    display:grid;
    gap:10px;
  }
  .fieldRow label{
    font-weight:1000;
    letter-spacing:.06em;
    font-size:12px;
    opacity:.8;
  }
  input{
    width:100%;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.35);
    color:var(--ice);
    padding:16px 16px;
    font-size:18px;
    font-weight:800;
    outline:none;
  }
  input:focus{
    border-color: rgba(0,229,255,.55);
    box-shadow:0 0 0 4px rgba(0,229,255,.12);
  }

  .ctaRow{
    display:flex; gap:10px; flex-wrap:wrap;
    margin-top:12px;
  }
  .btn{
    border:0;
    border-radius:18px;
    padding:14px 16px;
    font-size:16px;
    font-weight:1000;
    letter-spacing:.04em;
    cursor:pointer;
    color:#051018;
    background: linear-gradient(180deg, var(--cyan2), var(--cyan));
    box-shadow: 0 18px 50px rgba(0,229,255,.18);
    transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover{transform: translateY(-1px); filter:saturate(1.1); box-shadow:0 22px 70px rgba(0,229,255,.24)}
  .btn:active{transform: translateY(1px)}
  .btn.secondary{
    color:var(--ice);
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.14);
    box-shadow: 0 18px 50px rgba(0,0,0,.35);
  }

  /* ====== Game screen ====== */
  .arena{
    display:grid;
    gap:14px;
    padding:8px 6px 6px;
  }
  .questionBox{
    border-radius:22px;
    border:1px solid rgba(255,255,255,.14);
    background:
      radial-gradient(900px 260px at 50% 0%, rgba(0,229,255,.12), transparent 55%),
      rgba(0,0,0,.28);
    padding:18px 16px;
    position:relative;
    overflow:hidden;
  }
  .questionBox::after{
    content:"";
    position:absolute; inset:-2px;
    background: linear-gradient(90deg, transparent, rgba(0,229,255,.10), transparent);
    transform: skewX(-16deg) translateX(-65%);
    animation: qScan 4.4s linear infinite;
    opacity:.55;
    pointer-events:none;
  }
  @keyframes qScan{
    0%{transform: skewX(-16deg) translateX(-85%); opacity:.05}
    35%{opacity:.6}
    100%{transform: skewX(-16deg) translateX(85%); opacity:.05}
  }
  .qMeta{
    display:flex; gap:10px; flex-wrap:wrap;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
  }
  .qNo{
    font-weight:1000;
    letter-spacing:.08em;
    opacity:.85;
  }
  .timer{
    display:flex; align-items:center; gap:10px;
    font-weight:1000;
    letter-spacing:.06em;
  }
  .bar{
    width:180px; height:10px; border-radius:99px;
    background: rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12);
    overflow:hidden;
  }
  .bar > span{
    display:block;
    height:100%;
    width:100%;
    background: linear-gradient(90deg, var(--cyan), rgba(0,229,255,.35));
    box-shadow:0 0 18px rgba(0,229,255,.35);
    border-radius:99px;
    transform-origin:left center;
  }
  .qText{
    text-align:center;
    font-weight:1100;
    font-size: clamp(26px, 3.2vw, 54px);
    letter-spacing:.01em;
  }

  .optGrid{
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
  }
  @media(min-width: 740px){
    .optGrid{grid-template-columns: repeat(3, 1fr)}
  }
  .opt{
    border-radius:22px;
    border:1px solid rgba(0,229,255,.24);
    background: rgba(255,255,255,.06);
    padding:18px 14px;
    text-align:center;
    font-weight:1100;
    font-size: clamp(20px, 2.1vw, 34px);
    letter-spacing:.02em;
    cursor:pointer;
    user-select:none;
    color:#ffffff;
    text-shadow:0 0 12px rgba(255,255,255,.35);
    transition: transform .08s ease, border-color .2s ease, background .2s ease, box-shadow .2s ease;
    position:relative;
    overflow:hidden;
  }
  .opt::before{
    content:"";
    position:absolute; inset:-2px;
    background: radial-gradient(circle at 25% 20%, rgba(255,255,255,.20), transparent 45%);
    opacity:.55;
    pointer-events:none;
  }
  .opt:hover{
    transform: translateY(-1px);
    border-color: rgba(0,229,255,.55);
    background: rgba(0,229,255,.10);
    box-shadow: 0 0 0 1px rgba(0,229,255,.14), 0 18px 60px rgba(0,229,255,.12);
  }
  .opt.locked{pointer-events:none; opacity:.75}
  .opt.correct{
    border-color: rgba(77,255,154,.65);
    background: rgba(77,255,154,.10);
    box-shadow: 0 0 0 1px rgba(77,255,154,.14), 0 18px 60px rgba(77,255,154,.10);
  }
  .opt.wrong{
    border-color: rgba(255,59,122,.70);
    background: rgba(255,59,122,.10);
    box-shadow: 0 0 0 1px rgba(255,59,122,.16), 0 18px 60px rgba(255,59,122,.12);
  }

  .msgRow{
    display:flex;
    justify-content:center;
    min-height:44px;
    align-items:center;
    font-weight:1000;
    letter-spacing:.03em;
    opacity:.95;
    text-align:center;
  }
  .msgRow .ok{color:var(--ok); text-shadow:0 0 14px rgba(77,255,154,.25)}
  .msgRow .bad{color:var(--warn); text-shadow:0 0 14px rgba(255,59,122,.25)}

  /* ===== Villain row ===== */
.villainRow{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:10px;
}
.villainCard{
  border-radius:20px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.26);
  padding:12px 12px 10px;
  position:relative;
  overflow:hidden;
}
.villainCard::before{
  content:"";
  position:absolute; inset:-2px;
  background: radial-gradient(circle at 25% 20%, rgba(0,229,255,.14), transparent 55%);
  opacity:.9;
  pointer-events:none;
}
.villainCard[data-v="0"]{border-color: rgba(255,59,122,.35);}
.villainCard[data-v="1"]{border-color: rgba(0,229,255,.30);}
.villainCard[data-v="2"]{border-color: rgba(255,211,106,.26);}
.vTop{
  display:flex; align-items:center; justify-content:space-between;
  font-weight:1100;
  letter-spacing:.08em;
}
.vEmoji{font-size:22px; filter: drop-shadow(0 0 10px rgba(0,0,0,.45));}
.vName{
  font-size:14px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
}
.vSub{
  margin-top:6px;
  font-weight:900;
  font-size:12px;
  opacity:.78;
  letter-spacing:.08em;
}
.vBounty{
  margin-top:6px;
  font-weight:1200;
  font-size:18px;
  background: linear-gradient(90deg, #fff, var(--cyan2), #fff);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
  text-shadow: 0 0 18px rgba(0,229,255,.12);
}
.vBar{
  margin-top:10px;
  height:10px;
  border-radius:999px;
  background: rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.10);
  overflow:hidden;
}
.vBar > span{
  display:block; height:100%; width:0%;
  background: linear-gradient(90deg, var(--cyan), rgba(0,229,255,.22));
  box-shadow:0 0 18px rgba(0,229,255,.28);
  border-radius:999px;
  transition: width .18s ease;
}
.villainCard.dead{
  opacity:.22;
  filter: grayscale(1);
}
.villainCard.dead .vEmoji{transform: rotate(-12deg) scale(.92); opacity:.65;}
.villainCard.dead::after{
  content:"DISINTEGRATED";
  position:absolute; inset:0;
  display:grid; place-items:center;
  font-weight:1200;
  letter-spacing:.16em;
  font-size:12px;
  color: rgba(255,59,122,.55);
  background: rgba(0,0,0,.36);
}

/* ===== Money popup ===== */
.moneyPop{
  position:fixed;
  left:50%; top:50%;
  transform:translate(-50%,-50%);
  z-index:99;
  padding:18px 18px;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.16);
  background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.22));
  box-shadow: 0 30px 120px rgba(0,0,0,.65);
  text-align:center;
  min-width: min(520px, 92vw);
  display:none;
}
.moneyPop.show{display:block; animation: popIn .22s ease-out;}
@keyframes popIn{
  from{transform:translate(-50%,-50%) scale(.92); opacity:0}
  to{transform:translate(-50%,-50%) scale(1); opacity:1}
}
.moneyPop .big{
  font-weight:1300;
  font-size: clamp(32px, 5vw, 58px);
  letter-spacing:.06em;
  background: linear-gradient(90deg, #fff, var(--gold), #fff);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
  text-shadow: 0 24px 70px rgba(0,0,0,.65);
}
.moneyPop .line{
  margin-top:6px;
  font-weight:1000;
  letter-spacing:.08em;
  opacity:.9;
}
.moneyPop .small{
  margin-top:10px;
  font-weight:850;
  opacity:.82;
}

  /* ====== Result screen ====== */

  .result{
    display:grid;
    gap:12px;
    padding:10px 6px 6px;
    text-align:center;
  }
  .resultHero{
    border-radius:22px;
    border:1px solid rgba(255,255,255,.14);
    background:
      radial-gradient(900px 260px at 50% 0%, rgba(255,59,122,.18), transparent 58%),
      radial-gradient(800px 240px at 20% 10%, rgba(0,229,255,.12), transparent 55%),
      linear-gradient(180deg, rgba(0,0,0,.42), rgba(0,0,0,.18));
    padding:14px 12px;
    box-shadow: 0 22px 80px rgba(0,0,0,.45);
    position:relative;
    overflow:hidden;
  }
  .resultHero::after{
    content:"";
    position:absolute; inset:-2px;
    background: linear-gradient(90deg, transparent, rgba(255,59,122,.18), transparent);
    transform: skewX(-14deg) translateX(-70%);
    animation: qScan 4.2s linear infinite;
    opacity:.7;
    pointer-events:none;
  }
  .resultTitle{
    font-weight:1200;
    letter-spacing:.14em;
    text-transform:uppercase;
    font-size: clamp(18px, 2.6vw, 28px);
    color: rgba(255,255,255,.92);
    text-shadow: 0 10px 40px rgba(0,0,0,.55);
  }
  .resultSub{
    margin-top:6px;
    font-weight:1000;
    letter-spacing:.10em;
    opacity:.9;
    font-size: clamp(12px, 1.7vw, 16px);
  }
  .resultSub .alert{
    color: var(--warn);
    text-shadow: 0 0 18px rgba(255,59,122,.35);
  }

  .scoreBig{
    font-size: clamp(44px, 6.5vw, 104px);
    font-weight:1300;
    letter-spacing:.06em;
    background: linear-gradient(90deg, #fff, var(--cyan2), #fff);
    -webkit-background-clip:text;
    background-clip:text;
    color:transparent;
    text-shadow: 0 18px 60px rgba(0,0,0,.55);
  }
  .grade{
    font-weight:1200;
    letter-spacing:.10em;
    opacity:.92;
  }
  .mini{
    opacity:.86;
    font-weight:900;
  }

  .statGrid{
    display:grid;
    gap:10px;
    grid-template-columns: 1fr;
    margin-top:4px;
  }
  @media (min-width: 740px){
    .statGrid{ grid-template-columns: repeat(4, 1fr); }
  }
  .statCard{
    border-radius:20px;
    border:1px solid rgba(255,255,255,.14);
    background:
      radial-gradient(700px 240px at 20% 0%, rgba(0,229,255,.10), transparent 55%),
      radial-gradient(700px 240px at 80% 0%, rgba(255,59,122,.12), transparent 55%),
      rgba(0,0,0,.28);
    padding:12px 12px 10px;
    box-shadow: 0 16px 60px rgba(0,0,0,.35);
  }
  .statLabel{
    font-weight:1000;
    letter-spacing:.12em;
    font-size:12px;
    opacity:.80;
  }
  .statValue{
    margin-top:6px;
    font-weight:1300;
    font-size: clamp(22px, 2.8vw, 34px);
    background: linear-gradient(90deg, #fff, rgba(255,59,122,.9), #fff);
    -webkit-background-clip:text;
    background-clip:text;
    color:transparent;
    text-shadow: 0 10px 40px rgba(0,0,0,.55);
  }

  .resultActions{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
    margin-top:6px;
  }


  /* ====== Footer hint ====== */
  .foot{
    padding:10px 16px 16px;
    text-align:center;
    font-weight:850;
    opacity:.75;
    letter-spacing:.02em;
  }

  /* ====== TV boost ====== */
  @media (min-width: 1200px){
    .topbar{padding:22px 26px 14px}
    .badge{width:54px;height:54px;border-radius:18px}
    .brandText .ep{font-size:18px}
    .chip{padding:12px 14px; font-size:16px}
    .panel{border-radius:0; width:100%; max-width:none; min-height: calc(100vh - 96px);}
    .panelInner{padding:26px 34px 24px}
    .hero{padding:22px 22px 16px}
    .bar{width:240px;height:12px}
    input{font-size:22px; padding:18px}
    .btn{font-size:18px; padding:16px 18px}
    .opt{padding:22px 16px}
  }

  /* Safe areas (mobile notch) */
  .safeTop{padding-top: env(safe-area-inset-top);}
  .safeBottom{padding-bottom: env(safe-area-inset-bottom);}
/* ====== Mobile Fix (prevent bottom UI overlap) ====== */
@media (max-width: 520px), (max-height: 760px){
  body{ overflow:auto; }
  .stage{ min-height: 100svh; height:auto; }
  .main{ padding: 10px 12px 18px; }
  .topbar{ padding: 14px 12px 10px; align-items:flex-start; }
  .hud{ justify-content:flex-start; }
  .chip{ padding: 8px 10px; border-radius:14px; font-size: 13px; }
  .badge{ width:40px; height:40px; border-radius:14px; }
  .panel{ border-radius: 22px; }
  .panelInner{ padding: 14px 14px 16px; }
  .hero{ padding: 14px 12px 10px; border-radius: 18px; }
  .heroTitle .metal{ letter-spacing:.10em; }
  .startGrid{ padding: 8px 0 0; }
  .box{ padding: 12px 12px; border-radius: 18px; }
  input{ font-size: 18px; padding: 14px; }
  .btn{ width: 100%; justify-content:center; }
  .ctaRow{ width:100%; }
  .questionBox{ padding: 14px 12px; border-radius: 18px; }
  .bar{ width: 150px; }
  .opt{ padding: 16px 12px; border-radius: 18px; }
  .foot{ padding-bottom: calc(16px + env(safe-area-inset-bottom)); }
}

/* Allow scrolling inside the panel if content is taller than viewport */
.panelInner{
  max-height: calc(100svh - 110px);
  overflow:auto;
  -webkit-overflow-scrolling: touch;
}
</style>
</head>
<body>
<canvas id="fx"></canvas>
<div class="noise"></div>
<div class="scanlines"></div>

<div class="stage safeTop safeBottom">
  <div class="topbar">
    <div class="brand">
      <div class="badge" aria-hidden="true"></div>
      <div class="brandText">
        <div class="kicker">INFINITE LEARNING STUDIO ‚Ä¢ KRU PAI CLASSROOM</div>
        <div class="ep">EP5 ‚Ä¢ Dual Tense Warfare ‚Äî <span style="color:var(--cyan2)">CYBER BLUE</span> √ó <span style="color:var(--warn)">RED ALERT</span></div>
      </div>
    </div>
      <div class="hud" aria-label="HUD">
    <div class="chip"><span class="dot"></span>Score <b id="hudScore">0</b></div>
    <div class="chip"><span class="dot"></span>Streak <b id="hudStreak">0</b>/10</div>
    <div class="chip"><span class="dot"></span>Villains <b id="hudKills">0</b>/3</div>
    <div class="chip"><span class="dot"></span>Combo <b id="hudCombo">0</b></div>
  </div>
</div>

<div class="main">
    <div class="panel">
      <div class="panelInner">
        <div class="hero">
          <div class="flare" aria-hidden="true"></div>
          <div class="heroTitle"><div class="metal">SUBJECT SCANNER</div></div>
          <div class="tagline">PRESENT SIMPLE vs PRESENT CONTINUOUS ‚Ä¢ <b>CYBER BLUE √ó RED ALERT</b></div>
        </div>

        <!-- START SCREEN -->
        <section class="screen active" id="startScreen">
          <div class="startGrid">
            <div class="box">
              <h3>How to play</h3>
              <div class="how">
                <div class="pill"><i>1</i><div>Scan the SUBJECT first, then choose the correct verb form. Each hit damages the Boss. üí•</div></div>
                <div class="pill"><i>2</i><div>Wrong answer breaks your streak. Stay sharp‚Äîwatch the SUBJECT + TIME SIGNAL. üõ°Ô∏è</div></div>
                <div class="pill"><i>3</i><div>Build combo for extra points. Pro tip: NOW/RIGHT NOW ‚Üí Continuous ‚Ä¢ EVERY DAY/USUALLY ‚Üí Simple. ‚ö°</div></div>
              </div>
            </div>
            <div class="box">
              <h3>Player</h3>
              <div class="fieldRow">
                <label>YOUR NAME</label>
                <input id="playerName" type="text" placeholder="Type your name..." maxlength="24" />
              </div>
              <div class="ctaRow">
                <button class="btn" id="btnStart">‚ñ∂ START BATTLE</button>
                <button class="btn secondary" id="btnFull">‚õ∂ FULLSCREEN</button>
                <button class="btn secondary" id="btnSound">üîä SOUND: ON</button>
              </div>
              <div style="height:10px"></div>
              <div class="mini">Tip: On phone, turn landscape for big view. On TV, press Fullscreen.</div>
            </div>
          </div>
        </section>

        <!-- GAME SCREEN -->
        <section class="screen" id="gameScreen">
                <div class="arena">
<div class="villainRow" aria-label="Villains">
  <div class="villainCard" data-v="0">
    <div class="vTop"><span class="vEmoji">üòà</span><span class="vName">A</span></div>
    <div class="vSub">RED FIREWALL</div>
    <div class="vBounty">‡∏ø100</div>
    <div class="vBar"><span></span></div>
  </div>
  <div class="villainCard" data-v="1">
    <div class="vTop"><span class="vEmoji">üëø</span><span class="vName">B</span></div>
    <div class="vSub">CYBER DEMON</div>
    <div class="vBounty">‡∏ø100</div>
    <div class="vBar"><span></span></div>
  </div>
  <div class="villainCard" data-v="2">
    <div class="vTop"><span class="vEmoji">ü§ñ</span><span class="vName">C</span></div>
    <div class="vSub">AI GUARDIAN</div>
    <div class="vBounty">‡∏ø100</div>
    <div class="vBar"><span></span></div>
  </div>
</div>

<div class="questionBox">
              <div class="qMeta">
                <div class="qNo" id="qNo">QUESTION 1/12</div>
                <div class="timer">
                  <span>‚è≥</span><span id="tText">15s</span>
                  <div class="bar" aria-hidden="true"><span id="tBar"></span></div>
                </div>
              </div>
              <div class="qText" id="qText">Loading‚Ä¶</div>
            </div>

            <div class="optGrid" id="optGrid"></div>

            <div class="msgRow" id="msgRow"></div>

            <div class="ctaRow" style="justify-content:center;">
              <button class="btn secondary" id="btnHome">‚åÇ HOME</button>
              <button class="btn" id="btnNext">NEXT ‚ñ∂</button>
            </div>
          </div>
        </section>

        <!-- RESULT SCREEN -->
        <section class="screen" id="resultScreen">
  <div class="result">
    <div class="resultHero">
      <div class="resultTitle">MISSION RESULT</div>
      <div class="resultSub">CYBER BLUE √ó <span class="alert">RED ALERT</span></div>
    </div>

    <div class="scoreBig" id="finalScore">0</div>
    <div class="grade" id="finalGrade">MISSION REPORT</div>
    <div class="mini" id="finalLine">‚Äî</div>

    <div class="statGrid" aria-label="Battle Stats">
      <div class="statCard">
        <div class="statLabel">VILLAINS ELIMINATED</div>
        <div class="statValue"><span id="finalKills">0</span>/<span id="finalKillsMax">3</span></div>
      </div>
      <div class="statCard">
        <div class="statLabel">BOUNTY (THB)</div>
        <div class="statValue">‡∏ø<span id="finalBounty">0</span></div>
      </div>
      <div class="statCard">
        <div class="statLabel">BEST STREAK</div>
        <div class="statValue"><span id="finalBestStreak">0</span></div>
      </div>
      <div class="statCard">
        <div class="statLabel">MAX COMBO</div>
        <div class="statValue"><span id="finalMaxCombo">0</span></div>
      </div>
    </div>

    <div class="resultActions">
      <button class="btn" id="btnPlayAgain">‚Üª PLAY AGAIN</button>
      <button class="btn secondary" id="btnBackHome2">‚åÇ HOME</button>
      <button class="btn secondary" id="btnFull2">‚õ∂ FULLSCREEN</button>
    </div>
  </div>
</section>

      </div>
    </div>
  </div>

  <div class="foot">Made for kids ‚Ä¢ Train analysis ‚Ä¢ Simple vs Continuous ‚Ä¢ Cyber Blue √ó Red Alert ‚Ä¢ Kru Pai Classroom</div>
</div>

<div class="moneyPop" id="moneyPop" role="dialog" aria-live="polite">
  <div class="big" id="moneyBig">‡∏ø100 THB</div>
  <div class="line" id="moneyLine">BOUNTY CLAIMED!</div>
  <div class="small" id="moneySmall">Villain A disintegrated.</div>
</div>

<script>
/* ========= Question Set (sample) =========
   Replace / expand freely. Keep c index as correct choice.
*/
const QUESTIONS = [
  { q: "He ___ his grandma every Sunday.", tense: "simple", base: "visit", subject: "he", correct: "visits" },
  { q: "My brother ___ scary movies.", tense: "simple", base: "enjoy", subject: "he", correct: "enjoys" },
  { q: "The dog ___ the mailman.", tense: "simple", base: "chase", subject: "it", correct: "chases" },
  { q: "She ___ her diary every day.", tense: "simple", base: "write", subject: "she", correct: "writes" },
  { q: "It ___ dangerous sometimes.", tense: "simple", base: "seem", subject: "it", correct: "seems" },
  { q: "Our teacher ___ us math.", tense: "simple", base: "teach", subject: "she", correct: "teaches" },
  { q: "They ___ their friends after class.", tense: "simple", base: "meet", subject: "they", correct: "meet" },
  { q: "We ___ the windows on Fridays.", tense: "simple", base: "close", subject: "we", correct: "close" },
  { q: "My parents ___ in Bangkok.", tense: "simple", base: "live", subject: "they", correct: "live" },
  { q: "The students ___ new words every week.", tense: "simple", base: "memorize", subject: "they", correct: "memorize" },
  { q: "I ___ my desk every morning.", tense: "simple", base: "tidy", subject: "I", correct: "tidy" },
  { q: "Cats ___ at night.", tense: "simple", base: "hunt", subject: "they", correct: "hunt" },
  { q: "The phone ___ loudly.", tense: "simple", base: "ring", subject: "it", correct: "rings" },
  { q: "This machine ___ well.", tense: "simple", base: "operate", subject: "it", correct: "operates" },
  { q: "Anna ___ the answer quickly.", tense: "simple", base: "answer", subject: "she", correct: "answers" },
  { q: "Look! He ___ a tall building.", tense: "cont", base: "climb", subject: "he", correct: "is climbing" },
  { q: "Right now, they ___ for the taxi.", tense: "cont", base: "wait", subject: "they", correct: "are waiting" },
  { q: "She ___ a picture at the moment.", tense: "cont", base: "draw", subject: "she", correct: "is drawing" },
  { q: "We ___ to the museum today.", tense: "cont", base: "travel", subject: "we", correct: "are traveling" },
  { q: "I ___ right now.", tense: "cont", base: "type", subject: "I", correct: "am typing" },
  { q: "The kids ___ in the pool right now.", tense: "cont", base: "swim", subject: "they", correct: "are swimming" },
  { q: "Listen! The baby ___.", tense: "cont", base: "laugh", subject: "it", correct: "is laughing" },
  { q: "He ___ on the phone now.", tense: "cont", base: "talk", subject: "he", correct: "is talking" },
  { q: "They ___ a new game this week.", tense: "cont", base: "build", subject: "they", correct: "are building" },
  { q: "She ___ a message right now.", tense: "cont", base: "text", subject: "she", correct: "is texting" },
  { q: "We ___ dinner at the moment.", tense: "cont", base: "prepare", subject: "we", correct: "are preparing" },
  { q: "I ___ a shower now.", tense: "cont", base: "take", subject: "I", correct: "am taking" },
  { q: "The students ___ for the test right now.", tense: "cont", base: "review", subject: "they", correct: "are reviewing" },
  { q: "The cat ___ on the sofa now.", tense: "cont", base: "rest", subject: "it", correct: "is resting" },
  { q: "It ___ outside right now.", tense: "cont", base: "snow", subject: "it", correct: "is snowing" }
];
/* ===== Dual Tense option builder (Present Simple + Present Continuous) ===== */
function thirdPerson(base){
  if(base === "be") return "is";
  if(base === "have") return "has";
  if(base === "do") return "does";
  if(base === "go") return "goes";
  if(base === "ring") return "rings";
  if(base.endsWith("y") && !"aeiou".includes(base[base.length-2])) return base.slice(0,-1)+"ies";
  if(["s","x","z"].includes(base.slice(-1)) || base.endsWith("sh") || base.endsWith("ch") || base.endsWith("o")) return base+"es";
  return base+"s";
}

function ingForm(base){
  // simple & kid-friendly rules (+ a few common doubles)
  if(base.endsWith("ie")) return base.slice(0,-2) + "ying";           // die -> dying
  if(base.endsWith("e") && !base.endsWith("ee")) return base.slice(0,-1) + "ing"; // make -> making
  const doubles = new Set(["run","swim","sit","stop","plan","get","cut"]);
  if(doubles.has(base)) return base + base.slice(-1) + "ing";
  return base + "ing";
}

function auxFor(subject){
  if(subject === "I") return "am";
  if(subject === "we" || subject === "they") return "are";
  return "is"; // he/she/it + singular noun
}

function buildOptions(q){
  const correct = q.correct;
  const base = q.base || "";
  const subject = q.subject || "he";

  const seen = new Set([correct]);
  const opts = [correct];

  const add = (w)=>{
    if(!w) return;
    if(!seen.has(w)){
      seen.add(w);
      opts.push(w);
    }
  };

  if(q.tense === "cont"){
    const ing = ingForm(base);
    const aux = auxFor(subject);
    // Typical traps:
    add(thirdPerson(base));             // simple 3rd person
    add(base);                          // base form
    // wrong auxiliary + correct -ing
    if(aux !== "is") add("is " + ing);
    if(aux !== "are") add("are " + ing);
    if(aux !== "am") add("am " + ing);
    // common spelling trap (keep 'e' incorrectly)
    if(base.endsWith("e") && !base.endsWith("ee")) add(base + "ing"); // makeing (wrong)
  } else {
    // Present Simple traps:
    // plural subjects often need base form; singular needs 3rd person.
    add(base);                          // missing s/es
    add(thirdPerson(base));             // add s/es
    // a classic wrong form:
    if(base.endsWith("y") && !"aeiou".includes(base[base.length-2])) add(base + "s"); // studys (wrong)
    else add(base + "es");              // extra -es (wrong)
  }

  // Ensure exactly 3 options: correct + 2 distractors
  const fallbacks = [
    base, thirdPerson(base),
    auxFor(subject) + " " + ingForm(base),
    "is " + ingForm(base), "are " + ingForm(base), "am " + ingForm(base)
  ];
  for(const f of fallbacks){
    if(opts.length >= 3) break;
    add(f);
  }
  while(opts.length < 3) opts.push(correct);

  const finalOpts = [correct, ...opts.filter(x => x !== correct)].slice(0,3);

  // Shuffle
  for(let i=finalOpts.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [finalOpts[i], finalOpts[j]] = [finalOpts[j], finalOpts[i]];
  }
  return finalOpts;
}

const CFG = {
  timePerQ: 10,
  streakToKill: 10,
  villains: 3
};

const BOUNTY_PER_KILL_THB = 100;
const TOTAL_VILLAINS = CFG.villains;


let state = {
  idx: 0,
  order: [],
  score: 0,
  combo: 0,
  maxCombo: 0,
  locked: false,
  timer: null,
  timeLeft: CFG.timePerQ,
  soundOn: true,
  player: "",
  streak: 0,
  bestStreak: 0,
  kills: 0,
  currentVillain: 0,
  currentOptions: [],
  pendingNext: null
};

const $ = (id)=>document.getElementById(id);

function show(screenId){
  for(const el of document.querySelectorAll('.screen')) el.classList.remove('active');
  $(screenId).classList.add('active');
}

function clamp(n,a,b){return Math.max(a, Math.min(b,n));}

/* ===== Sound (WebAudio) ===== */
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}
function beep(type="ok"){
  if(!state.soundOn) return;
  ensureAudio();
  const t0 = audioCtx.currentTime;

  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  const f = audioCtx.createBiquadFilter();
  f.type = "lowpass";
  f.frequency.value = type==="ok" ? 1600 : 900;

  o.type = type==="ok" ? "sawtooth" : "square";
  o.frequency.setValueAtTime(type==="ok" ? 520 : 220, t0);
  o.frequency.exponentialRampToValueAtTime(type==="ok" ? 860 : 140, t0 + 0.14);

  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(type==="ok" ? 0.22 : 0.18, t0 + 0.03);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);

  o.connect(f); f.connect(g); g.connect(audioCtx.destination);
  o.start(t0);
  o.stop(t0 + 0.2);
}

function rumble(){
  if(!state.soundOn) return;
  ensureAudio();
  const t0 = audioCtx.currentTime;
  const n = audioCtx.createBufferSource();
  const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.18, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0;i<data.length;i++){
    data[i] = (Math.random()*2-1) * Math.exp(-i/data.length*4);
  }
  n.buffer = buffer;

  const g = audioCtx.createGain();
  g.gain.value = 0.18;
  const f = audioCtx.createBiquadFilter();
  f.type="lowpass"; f.frequency.value=260;

  n.connect(f); f.connect(g); g.connect(audioCtx.destination);
  n.start(t0);
}

function tickClock(whole){
  if(!state.soundOn) return;
  ensureAudio();
  const t0 = audioCtx.currentTime;

  // higher pitch & slightly faster feel in last 3 seconds
  const urgent = (whole <= 3);
  const freq = urgent ? 1200 : 820;
  const dur  = urgent ? 0.055 : 0.05;

  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "square";
  o.frequency.setValueAtTime(freq, t0);

  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(urgent ? 0.16 : 0.12, t0 + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

  o.connect(g); g.connect(audioCtx.destination);
  o.start(t0);
  o.stop(t0 + dur);

  // extra mini-tick for urgency (last 3 seconds)
  if(urgent){
    const o2 = audioCtx.createOscillator();
    const g2 = audioCtx.createGain();
    o2.type="square";
    o2.frequency.setValueAtTime(freq*1.15, t0 + 0.08);
    g2.gain.setValueAtTime(0.0001, t0 + 0.08);
    g2.gain.exponentialRampToValueAtTime(0.10, t0 + 0.09);
    g2.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.08 + 0.045);
    o2.connect(g2); g2.connect(audioCtx.destination);
    o2.start(t0 + 0.08);
    o2.stop(t0 + 0.08 + 0.05);
  }
}


function updateHUD(){
  $('hudScore').textContent = state.score;
  $('hudCombo').textContent = state.combo;
  $('hudStreak').textContent = state.streak;
  $('hudKills').textContent = state.kills;
}

function updateVillainUI(){
  const cards = document.querySelectorAll('.villainCard');
  cards.forEach((c, i)=>{
    c.classList.toggle('dead', i < state.kills);
    const bar = c.querySelector('.vBar > span');
    if(bar){
      const progress = (i < state.kills) ? 100 : (i === state.currentVillain ? (state.streak / CFG.streakToKill) * 100 : 0);
      bar.style.width = Math.max(0, Math.min(100, progress)) + "%";
    }
  });
}

function showMoney(amount, label, detail){
  const pop = document.getElementById('moneyPop');
  document.getElementById('moneyBig').textContent = `‡∏ø${amount} THB`;
  document.getElementById('moneyLine').textContent = label;
  document.getElementById('moneySmall').textContent = detail;
  pop.classList.add('show');
  setTimeout(()=>pop.classList.remove('show'), 1200);
}

function killVillain(){
  // mark current villain dead
  const names = ["A","B","C"];
  const killedName = names[state.currentVillain] || "X";
  state.kills += 1;
  state.currentVillain = Math.min(state.kills, CFG.villains-1);
  state.streak = 0; // reset streak to start next villain
  updateVillainUI();

  blastParticles(true);
  bigConfetti();
  showMoney(100, "BOUNTY CLAIMED!", `Villain ${killedName} disintegrated.`);
}

function updateVillainProgress(resetOnly=false){
  // update progress bar for current villain
  updateVillainUI();
  if(resetOnly) return;

  if(state.streak >= CFG.streakToKill){
    killVillain();
  }
  // If all villains dead, optional mega reward
  if(state.kills >= CFG.villains){
    showMoney(300, "üí∞ TOTAL BOUNTY!", "All villains eliminated. SUBJECT SCANNER!");
  }
}

function resetRun(){
  state.idx = 0;
  state.order = [...Array(QUESTIONS.length).keys()].sort(()=>Math.random()-0.5);
  state.score = 0;
  state.combo = 0;
  state.maxCombo = 0;
  state.locked = false;
  state.timeLeft = CFG.timePerQ;
  clearInterval(state.timer); state.timer = null;
  state.streak = 0;
  state.bestStreak = 0;
  state.kills = 0;
  state.currentVillain = 0;
  state.currentOptions = [];
  $('msgRow').textContent = "";
  updateVillainUI();
  updateHUD();
}

function setMessage(html){
  $('msgRow').innerHTML = html || "";
}

function startTimer(){
  clearInterval(state.timer);
  state.timeLeft = CFG.timePerQ;
  const tBar = $('tBar');
  const tText = $('tText');
  let lastWhole = Math.ceil(state.timeLeft);

  tText.textContent = lastWhole + "s";
  tBar.style.transform = "scaleX(1)";

  // One tick immediately (feels like countdown starts)
  tickClock(lastWhole);

  state.timer = setInterval(()=>{
    state.timeLeft -= 0.1;
    state.timeLeft = clamp(state.timeLeft, 0, CFG.timePerQ);

    const whole = Math.ceil(state.timeLeft);
    if(whole !== lastWhole){
      lastWhole = whole;
      tickClock(whole);
    }

    tText.textContent = whole + "s";
    tBar.style.transform = "scaleX(" + (state.timeLeft/CFG.timePerQ).toFixed(3) + ")";

    if(state.timeLeft <= 0){
      clearInterval(state.timer);
      timeoutFail();
    }
  }, 100);
}

function loadQuestion(){
  if(state.pendingNext){ clearTimeout(state.pendingNext); state.pendingNext=null; }
  state.locked = false;
  setMessage("");
  const total = QUESTIONS.length;
  const q = QUESTIONS[state.order[state.idx]];

  $('qNo').textContent = "QUESTION " + (state.idx+1) + "/" + total;
  $('qText').textContent = q.q;

  const options = buildOptions(q);
  state.currentOptions = options;

  const grid = $('optGrid');
  grid.innerHTML = "";
  options.forEach((txt,i)=>{
    const b = document.createElement('div');
    b.className = 'opt';
    b.textContent = txt;
    b.onclick = ()=>choose(i, b);
    grid.appendChild(b);
  });

  startTimer();
  $('btnNext').disabled = true;
  $('btnNext').style.opacity = .65;
}

function lockOptions(){
  for(const el of document.querySelectorAll('.opt')){
    el.classList.add('locked');
  }
  state.locked = true;
  clearInterval(state.timer);
}

function choose(i, el){
  if(state.locked) return;
  lockOptions();

  const q = QUESTIONS[state.order[state.idx]];
  const selected = (state.currentOptions && state.currentOptions[i]) ? state.currentOptions[i] : el.textContent;
  const correctText = q.correct;

  const correct = (selected === correctText);

  if(correct){
    el.classList.add('correct');
    state.combo += 1;
    state.maxCombo = Math.max(state.maxCombo, state.combo);
    const gain = 2 + Math.min(6, state.combo);
    state.score += gain;
    beep("ok");
    rumble();
    blastParticles(true);

    // streak system
    state.streak += 1;
    state.bestStreak = Math.max(state.bestStreak, state.streak);
    setMessage(`<span class="ok">‚úÖ PERFECT HIT! +${gain} ‚Ä¢ STREAK ${state.streak}/10</span>`);

    updateVillainProgress();

  }else{
    el.classList.add('wrong');
    const opts = [...document.querySelectorAll('.opt')];
    for(const o of opts){
      if(o.textContent === correctText) o.classList.add('correct');
    }
    state.combo = 0;
    state.streak = 0; // reset streak on mistake
    beep("bad");
    blastParticles(false);
    setMessage(`<span class="bad">‚úñ WRONG! Streak reset.</span>`);
    updateVillainProgress(true);
  }

  updateHUD();
  endCheck();
  scheduleAutoNext(850);
}

function timeoutFail(){
  if(state.locked) return;
  lockOptions();
  state.combo = 0;
  state.streak = 0;
  beep("bad");
  blastParticles(false);
  setMessage(`<span class="bad">‚åõ TIME UP! Streak reset.</span>`);
  updateVillainProgress(true);
  updateHUD();
  endCheck();
  scheduleAutoNext(850);
}

function endCheck(){
  $('btnNext').disabled = false;
  $('btnNext').style.opacity = 1;
  const finished = (state.idx >= QUESTIONS.length-1);
  $('btnNext').textContent = finished ? "FINISH ‚ñ∂" : "NEXT ‚ñ∂";
}

function next(){
  // allow next anytime after a question is locked
  if(state.pendingNext){ clearTimeout(state.pendingNext); state.pendingNext = null; }

  const finished = (state.idx >= QUESTIONS.length-1);
  if(finished){
    showResult();
    return;
  }
  state.idx += 1;
  loadQuestion();
}

function scheduleAutoNext(delayMs=850){
  if(state.pendingNext){ clearTimeout(state.pendingNext); }
  state.pendingNext = setTimeout(()=>{
    state.pendingNext = null;
    // if user already clicked NEXT, state.idx may have changed; just guard
    if(state.locked){
      next();
    }
  }, delayMs);
}


function gradeLine(){
  const maxScore = QUESTIONS.length * 8; // approximate
  const pct = Math.round((state.score / maxScore) * 100);
  const bounty = state.kills * BOUNTY_PER_KILL_THB;

  if(state.kills >= TOTAL_VILLAINS) return { title:"üö® RED ALERT CLEARED!", line:`All villains eliminated. Bounty: ‡∏ø${bounty} THB ‚Ä¢ Best streak: ${state.bestStreak}.` };
  if(state.kills === 2) return { title:"üî• ELITE HUNTER", line:`2 villains down. Bounty: ‡∏ø${bounty} THB ‚Ä¢ Best streak: ${state.bestStreak}.` };
  if(state.kills === 1) return { title:"‚ö° GOOD HUNTER", line:`1 villain down. Bounty: ‡∏ø${bounty} THB ‚Ä¢ Best streak: ${state.bestStreak}.` };
  if(pct >= 70) return { title:"üß™ TRAINING RUN", line:`Good accuracy. Best streak: ${state.bestStreak}. Keep scanning the subject!` };
  return { title:"üß™ PRACTICE MORE", line:`Look at the subject (singular/plural) before you shoot. Best streak: ${state.bestStreak}.` };
}

function showResult(){
  clearInterval(state.timer);
  show('resultScreen');

  $('finalScore').textContent = state.score;

  const g = gradeLine();
  $('finalGrade').textContent = g.title;
  $('finalLine').textContent = g.line;

  // Stats
  const bounty = state.kills * BOUNTY_PER_KILL_THB;
  const killsMaxEl = document.getElementById('finalKillsMax');
  if(killsMaxEl) killsMaxEl.textContent = TOTAL_VILLAINS;

  const kEl = document.getElementById('finalKills');
  const bEl = document.getElementById('finalBounty');
  const sEl = document.getElementById('finalBestStreak');
  const cEl = document.getElementById('finalMaxCombo');

  if(kEl) kEl.textContent = state.kills;
  if(bEl) bEl.textContent = bounty;
  if(sEl) sEl.textContent = state.bestStreak;
  if(cEl) cEl.textContent = state.maxCombo;

  if(state.kills >= TOTAL_VILLAINS){
    bigConfetti();
    // One final bounty popup for the kids üòàüí∞
    showMoney(bounty, "TOTAL BOUNTY!", "All villains eliminated. WE GO UP!");
  }
}

function startBattle(){
  state.player = $('playerName').value.trim();
  resetRun();
  show('gameScreen');
  loadQuestion();
}

function goHome(){
  clearInterval(state.timer);
  show('startScreen');
}

/* ===== Fullscreen ===== */
function toggleFull(){
  const el = document.documentElement;
  const isFull = document.fullscreenElement;
  if(!isFull){
    (el.requestFullscreen?.() || el.webkitRequestFullscreen?.() || el.msRequestFullscreen?.()).catch(()=>{});
  }else{
    (document.exitFullscreen?.() || document.webkitExitFullscreen?.() || document.msExitFullscreen?.()).catch(()=>{});
  }
}

/* ===== Buttons ===== */
$('btnStart').addEventListener('click', ()=>{
  // unlock audio on mobile
  try{ ensureAudio(); audioCtx.resume?.(); }catch(e){}
  startBattle();
});
$('btnHome').addEventListener('click', goHome);
$('btnBackHome2').addEventListener('click', goHome);
$('btnPlayAgain').addEventListener('click', ()=>{
  resetRun();
  show('gameScreen');
  loadQuestion();
});
$('btnNext').addEventListener('click', next);
$('btnFull').addEventListener('click', toggleFull);
$('btnFull2').addEventListener('click', toggleFull);
$('btnSound').addEventListener('click', ()=>{
  state.soundOn = !state.soundOn;
  $('btnSound').textContent = state.soundOn ? "üîä SOUND: ON" : "üîá SOUND: OFF";
  if(state.soundOn){
    try{ ensureAudio(); audioCtx.resume?.(); beep("ok"); }catch(e){}
  }
});

/* ===== FX Canvas (particles + flare) ===== */
const canvas = document.getElementById('fx');
const ctx = canvas.getContext('2d');
let W=0,H=0, DPR=1;
function resize(){
  DPR = Math.min(2, window.devicePixelRatio || 1);
  W = canvas.width = Math.floor(innerWidth * DPR);
  H = canvas.height = Math.floor(innerHeight * DPR);
  canvas.style.width = innerWidth + "px";
  canvas.style.height = innerHeight + "px";
}
window.addEventListener('resize', resize);
resize();

let particles = [];
function spawn(x,y,color, n, power){
  for(let i=0;i<n;i++){
    const a = Math.random()*Math.PI*2;
    const sp = (power*(0.6+Math.random()*0.9))*DPR;
    particles.push({
      x:x*DPR, y:y*DPR,
      vx: Math.cos(a)*sp,
      vy: Math.sin(a)*sp,
      life: 28 + Math.random()*18,
      r: 2 + Math.random()*4,
      color
    });
  }
}
function blastParticles(ok){
  const cx = innerWidth/2, cy = innerHeight/2;
  const color = ok ? "rgba(77,255,154,0.95)" : "rgba(255,59,122,0.95)";
  spawn(cx, cy, color, ok? 90: 70, ok? 10: 8);
  // lens flare streak
  flares.push({t:0, ok});
}
let flares = [];
function bigConfetti(){
  const color = "rgba(0,229,255,0.95)";
  for(let k=0;k<7;k++){
    spawn(innerWidth*(0.2+Math.random()*0.6), innerHeight*0.25, color, 60, 9);
  }
  flares.push({t:0, ok:true, big:true});
}

function tick(){
  ctx.clearRect(0,0,W,H);

  // subtle nebula glow
  const grd = ctx.createRadialGradient(W*0.5, H*0.18, 20, W*0.5, H*0.18, Math.max(W,H)*0.8);
  grd.addColorStop(0, "rgba(0,229,255,0.08)");
  grd.addColorStop(1, "rgba(0,0,0,0)");
  ctx.fillStyle = grd;
  ctx.fillRect(0,0,W,H);

  // flares
  for(let i=flares.length-1;i>=0;i--){
    const f = flares[i];
    f.t += 0.03;
    const alpha = Math.sin(Math.min(1,f.t)*Math.PI) * (f.big? .55 : .38);
    const x = W*(0.15 + f.t*0.9);
    const y = H*(0.18 + (f.ok? 0.0 : 0.08));
    ctx.save();
    ctx.globalCompositeOperation = "screen";
    ctx.globalAlpha = alpha;
    ctx.translate(x,y);
    ctx.rotate(-0.15);
    const w = W*0.65, h = 2*DPR;
    ctx.fillStyle = f.ok ? "rgba(0,229,255,1)" : "rgba(255,59,122,1)";
    ctx.shadowColor = f.ok ? "rgba(0,229,255,1)" : "rgba(255,59,122,1)";
    ctx.shadowBlur = 26*DPR;
    ctx.fillRect(-w/2, -h/2, w, h);
    ctx.restore();
    if(f.t>=1) flares.splice(i,1);
  }

  // particles
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.life -= 1;
    p.vx *= 0.96; p.vy *= 0.96;
    p.vy += 0.06*DPR; // slight gravity
    p.x += p.vx;
    p.y += p.vy;
    const a = Math.max(0, p.life/46);
    ctx.globalAlpha = a;
    ctx.fillStyle = p.color;
    ctx.shadowColor = p.color;
    ctx.shadowBlur = 18*DPR;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r*DPR, 0, Math.PI*2);
    ctx.fill();
    if(p.life<=0) particles.splice(i,1);
  }
  ctx.globalAlpha = 1;
  requestAnimationFrame(tick);
}
tick();

/* Start screen ambient flare */
setTimeout(()=>{ flares.push({t:0, ok:true, big:true}); }, 500);

/* Make sure "Next" works even if user taps fast */
document.addEventListener('keydown', (e)=>{
  if(e.key === "Enter"){
    if(document.getElementById('gameScreen').classList.contains('active')) next();
    if(document.getElementById('startScreen').classList.contains('active')) startBattle();
  }
});
</script>
</body>
</html>
